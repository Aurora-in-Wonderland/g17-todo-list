<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>TODO LIST</title>
    <style>
      html {
        width: 100vw;
        height: 100vh;

        max-width: 450px;

        background-position: center;
        background-size: cover;

        margin: auto;
      }

      body {
        border: 2px solid #f2d8d8;
        background-color: #fffbf5;
        min-height: 100%;
        font-family: "Noto Sans KR", sans-serif;
        font-size: 12px;
        text-align: center;
      }

      h1 {
        font-size: 32px;
        text-align: center;

        padding: 50px 0 30px 0;
      }

      .todo_list {
        width: 350px;

        margin: auto;
      }

      .input_box {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-self: center;
      }
      .todo-input {
        width: 250px;
        height: 40px;
      }
      .input_box > button {
        width: 60px;
        height: 45px;

        border-radius: 5px;
        border: none;
        background-color: #f2d8d8;
        cursor: pointer;
        font-weight: bold;
      }

      .input_box > button:hover {
        color: #f2d8d8;
        box-shadow: 0 80px 0 0 rgba(0, 0, 0, 0.1) inset,
          0 -80px 0 0 rgba(0, 0, 0, 0.1) inset;
      }

      .btn-check {
        background-color: #f2d8d8;
      }

      .btn-group {
        margin: 30px;
      }

      .lists {
        /* 테두리 겹침을 없애는 법? */
      }
      .list {
        width: 350px;
        height: 35px;
        border: 1px solid #f2d8d8;

        text-align: center;

        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-self: center;

        position: relative;

        padding: 0;
      }

      .check_box {
        margin-left: 10px;
      }

      .list > button {
        width: 35px;
        height: 35px;

        color: #f2d8d8;
        background-color: transparent;

        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      .done_check {
        text-decoration: line-through;
      }
    </style>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <script
      src="https://kit.fontawesome.com/6324b7cd5d.js"
      crossorigin="anonymous"
    ></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <script>
      $(document).ready(function () {
        show_todo();
      });

      function show_todo() {
        fetch("/todo")
          .then((res) => res.json())
          .then((data) => {
            $("#todo-list").empty();
            let rows = data["result"];
            rows.forEach((a) => {
              let todo = a["todo"];
              let num = a["num"];
              let done = a["done"];
              let temp_html = ``;
              if (done === 1) {
                temp_html = `
              <div class="list" id=${num}>
                <p class="check_box">✔</p>
                <p class="done_check">${todo}</p>
                <button onclick="deletebtn('${num}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            `;
              } else {
                temp_html = `
              <div class="list" id=${num}>
                <button onclick="done_todo(${num})">
                  <p class="check_box">✔</p>
                </button>
                <p>${todo}</p>
                <button onclick="deletebtn('${num}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            `;
              }

              $("#todo-list").append(temp_html);
            });
          });
      }

      function save_todo() {
        let todo = $("#todo").val();

        if (todo.length == 0) {
          alert("내용을 입력해주세요.");
          $("#todo").focus();
          return false;
        }

        let formData = new FormData();
        formData.append("todo_give", todo);

        fetch("/todo", { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            alert(data["msg"]);
            window.location.reload();
          });
      }

      function done_todo(num) {
        let formData = new FormData();
        formData.append("done_give", num);
        fetch("/todo/done", { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            alert(data["msg"]);
            window.location.reload();
          })
          .catch((err) => {
            console.log(err);
          });
      }

      function deletebtn(num) {
        // 삭제하기
        let formData = new FormData();
        formData.append("num", num);
        fetch("/todo", { method: "DELETE", body: formData })
          .then((res) => res.json())
          .then((data) => {
            alert(data["msg"]);
            window.location.reload();
          });
      }

      function todosDo() {
        fetch("/todo")
          .then((res) => res.json())
          .then((data) => {
            $("#todo-list").empty();
            let list = data["result"];
            list.forEach((a) => {
              let todo = a["todo"];
              let state = a["state"];
              let show_todoDo = data["actives"];
              console.log(state);
              $("#todosDo").click(function () {
                if (state === 0) {
                  $("#todo-list").show();
                } else {
                  $("#todo-list").hide();
                }
              });
            });
          });
      }

      function todosDone() {
        fetch("/todo")
          .then((res) => res.json())
          .then((data) => {
            let doDone = data["result"];
            doDone.forEach((a) => {
              let todo = a["todo"];
              let state = a["state"];
              let show_todoDone = data["done"];
              console.log(state);
              $("#todosDone").click(function () {
                state === 1 ? show_todoDone : console.log("한숨만");
              });
            });
          });
      }

      document.addEventListener("click", function (event) {
        if (event.target.matches(".list p")) {
          change_todo();
        }
      });

      function change_todo() {
        let todo = $("#change_todo").val();
        let num = $("#change_todo").val();

        console.log(num);
        console.log(todo);

        let formData = new FormData();
        formData.append("todo_give", todo);
        formData.append("num_give", num);

        fetch("/todo", { method: "PUT", body: formData })
          .then((response) => response.json())
          .then((data) => {
            // 수정된 데이터 같이 보내줌.

            let change_html = `<li id="change_todo" class="list" onclick="change_todo()">
                                <div class="check_box">✔</div>
                                <p>${todo}</p>
                                <button onclick="deletebtn()">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                               </li>`;
            $(".list p")
              .eq(num - 1)
              .replaceWith(change_html);

            // alert(data["msg"]);
            // window.location.reload();
          });
        // });
      }
    </script>
  </head>
  <body>
    <h1>Todo List</h1>
    <ul class="lists" id="todo-list">
      <li id="change_todo" class="list" onclick="change_todo()">
        <div class="check_box">✔</div>
        <p>첫번째 할 일</p>
        <button onclick="deletebtn()">
          <i class="fas fa-trash-alt"></i>
        </button>
      </li>
      <!-- 이벤트 버블링 이벤트 캡처링 => li에 줘야함-->
      <li id="change_todo" class="list">
        <div class="check_box">✔</div>
        <p>두번째 할 일</p>
        <button onclick="deletebtn()">
          <i class="fas fa-trash-alt"></i>
        </button>
      </li>
      <li id="change_todo" class="list">
        <div class="check_box">✔</div>
        <p>세번째 할 일</p>
        <button onclick="deletebtn()">
          <i class="fas fa-trash-alt"></i>
        </button>
      </li>
    </ul>

    <!-- 입력창 -->
    <div class="todo_list">
      <div class="input_box">
        <input
          type="text"
          id="todo"
          class="todo-input"
          maxlength="15"
          placeholder=" 해야 할 일을 입력해주세요."
        />
        <button onclick="save_todo()" type="button" class="complete-all-btn">
          입력
        </button>
      </div>
      <button onclick="change_todo()">CHANGE</button>

      <!-- 분류 버튼 -->
      <div class="filter_btn">
        <button id="showAll" data-type="all">All</button>
        <button id="todosDo" data-type="active">Active</button>
        <button id="todosDone" data-type="completed">Completed</button>
      </div>

      <ul class="lists" id="todo-list">
        <li id="change_todo" class="list" onclick="change_todo()">
          <div class="check_box">✔</div>
          <p>첫번째 할 일</p>
          <button onclick="deletebtn()">
            <i class="fas fa-trash-alt"></i>
          </button>
        </li>
        <li id="change_todo" class="list">
          <div class="check_box">✔</div>
          <p>두번째 할 일</p>
          <button onclick="deletebtn()">
            <i class="fas fa-trash-alt"></i>
          </button>
        </li>
        <li id="change_todo" class="list">
          <div class="check_box">✔</div>
          <p>세번째 할 일</p>
          <button onclick="deletebtn()">
            <i class="fas fa-trash-alt"></i>
          </button>
        </li>
      </ul>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
    integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
    crossorigin="anonymous"
  ></script>
</html>
